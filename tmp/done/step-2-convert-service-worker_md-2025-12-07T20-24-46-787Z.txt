<github_issue>

**Issue URL:** https://github.com/ziyaaktas/tab-limiter/issues/1

**Title:** Convert background.js to MV3 Service Worker

**Labels:** enhancement

**Status:** Added to project "tab-limiter" in the "Todo" lane

---

## Summary

Convert `background.js` from a persistent background page (MV2) to a service worker (MV3). Service workers have fundamentally different lifecycle characteristics: they terminate when idle (~30 seconds) and lose all in-memory state. This requires restructuring how state is managed and how event listeners are registered.

## Background

Service workers replace background pages in Manifest V3. Key differences:

| Aspect | Background Page (MV2) | Service Worker (MV3) |
|--------|----------------------|---------------------|
| Lifecycle | Persistent, always running | Terminates when idle (~30s) |
| Global state | Persists in memory | Lost on termination |
| DOM access | Has `window`, `document` | No DOM access |
| Event listeners | Can register anytime | Must register synchronously at startup |

## Current Issues in `background.js`

### 1. Global State Variables (Lines 110-134)
```javascript
let tabCount = -1
let previousTabCount = -1
let amountOfTabsCreated = -1
let passes = 0;
```
These variables will be lost when the service worker terminates, causing incorrect tab counting and pass tracking after wake-up.

### 2. Late Event Listener Registration (Lines 199-214)
Event listeners are registered inside `app.init()`, which is called at the end of the script. In MV3, event listeners **must** be registered at the top level synchronously during initial script execution, or events may be missed when the service worker wakes up.

### 3. `alert()` Usage (Line 107)
Service workers have no DOM access. The `alert()` call in `displayAlert()` will fail. Needs replacement with `chrome.notifications` API.

### 4. `browserAction` API Usage (Lines 18-28)
`chrome.browserAction` is renamed to `chrome.action` in MV3.

## Acceptance Criteria

- [ ] All global state variables moved to `chrome.storage.session`
- [ ] Event listeners registered at top level synchronously
- [ ] State management functions created (`getSessionState`, `updateSessionState`)
- [ ] Replace `alert()` with `chrome.notifications` API
- [ ] Replace `browserAction` with `action` API
- [ ] No `window` or `document` references
- [ ] Add `chrome.runtime.onInstalled` listener for first-time setup
- [ ] Service worker initializes correctly on wake-up
- [ ] Badge updates correctly after browser restart
- [ ] Tab limiting works after service worker goes idle and wakes

## Implementation Plan

### 1. State Management Layer
### 2. Top-Level Event Registration
### 3. Notifications Instead of Alert
### 4. API Updates

## Validation Checklist

- [ ] All event listeners registered at top level synchronously
- [ ] Global variables moved to `chrome.storage.session`
- [ ] No `window`, `document`, or `alert()` references
- [ ] Service worker initializes correctly on wake
- [ ] Badge updates correctly after browser restart
- [ ] Tab limiting works after service worker goes idle and wakes
- [ ] Test with DevTools "Stop" button to simulate termination

## Resources

- [Migrate to a service worker | Chrome for Developers](https://developer.chrome.com/docs/extensions/develop/migrate/to-service-workers)
- [Extension service worker basics | Chrome for Developers](https://developer.chrome.com/docs/extensions/develop/concepts/service-workers/basics)
- [chrome.storage API | Chrome for Developers](https://developer.chrome.com/docs/extensions/reference/api/storage)
- [The extension service worker lifecycle | Chrome for Developers](https://developer.chrome.com/docs/extensions/mv3/service_workers/service-worker-lifecycle/)

</github_issue>
